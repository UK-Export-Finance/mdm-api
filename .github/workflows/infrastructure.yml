# This GHA is responsible for `APIM` supporting infrastructure
# creation and configuration using `az cli` bash scripting.
#
# Standard Azure naming convention has been followed:
# https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming
# A minor modification to standard naming convention has been made to not include region.
#
#
# Following Azure services are consumed:
# 1. Azure resource group - https://learn.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create
# 2. Azure container registry - https://learn.microsoft.com/en-us/cli/azure/acr?view=azure-cli-latest#az-acr-create
# 3. Azure virtual network - https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview
# 4. Azure virtual network peer - https://learn.microsoft.com/en-us/cli/azure/network/vnet/peering?view=azure-cli-latest
# 5. Azure container app environment - https://learn.microsoft.com/en-us/azure/container-apps/environment
# 6. Azure container app - https://learn.microsoft.com/en-us/azure/container-apps/containers
#
#
# Execution
# *********
# GHA is only invoked when following conditions are satisfied:
# 1. Push to the `infrastructure` branch only.
# 2. Exact file path matches `.github/workflows/infrastructure.yml`.
#
# TO-DO
# *****
# 1. Add delete locks
# 2. Add log workspace
# 3. Add Insight
# 4. Add monitor
# 5. Add Key vault

name: Infrastructure üî®
run-name: APIM base infrastructure build from ${{ github.repository }}

on:
  push:
    branches:
      - infrastructure
      # TODO: Remove pre PR merge
      - APIM-162-set-up-azure-api-management
    paths: [ .github/workflows/infrastructure.yml ]

env:
  product: apim
  environment: infrastructure
  timezone: 'Europe/London'
  # Deployment environment target i.e., `dev`, `staging`, `prod`
  target: ${{ vars.environment }}

jobs:
  # 1. Setup infrastructure variables
  setup:
    name: Setup üîß
    runs-on: [ self-hosted, APIM, infrastructure ]
    outputs:
      environment: ${{ env.environment }}
      timezone: ${{ env.timezone }}
    steps:
      - name: Environment üß™
        run: echo "Environment set to ${{ env.environment }}"

      - name: Timezone üåê
        run: echo "Timezone set to ${{ env.timezone }}"

  # 2. Base infrastructure creation
  base:
    name: Base üß±
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      environment: ${{ env.environment }}
    runs-on: [ self-hosted, APIM, infrastructure ]
    steps:
      - name: Pre-production üí´
        if: contains('["dev", "staging"]', env.target)
        run: echo "type=Preproduction" >> $GITHUB_ENV

      - name: Production üí´
        if: ${{ 'prod' == env.target }}
        run: echo "type=Production" >> $GITHUB_ENV

      - name: Tags üè∑Ô∏è
        run: echo tags='Environment=${{ env.type }}' \
          'Product=${{ env.product }}' \
          'Team=development' >> $GITHUB_ENV

      - name: Login üîê
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure defaults ‚ú®
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            # Basic
            az configure --defaults location=${{ vars.REGION }}
            az configure --defaults group=rg-${{ env.product }}-${{ env.target }}-001

            # AZ CLI extensions upgrade
            az extension add --name containerapp --upgrade

      - name: Resource group üèóÔ∏è
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az group create \
            --name rg-${{ env.product }}-${{ env.target }}-001 \
            --tags ${{ env.tags }}

      - name: Container registry üì¶Ô∏è
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az acr create \
            --name cr${{ env.product }}${{ env.target }}001 \
            --sku Standard \
            --admin-enabled true \
            --tags ${{ env.tags }}

      - name: Virtual network üßµ
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az network vnet create \
            --name vnet-${{ env.product }}-001 \
            --address-prefix ${{ secrets.VNET_ADDRESS_PREFIX }} \
            --subnet-name snet-${{ env.product }}-001 \
            --subnet-prefixes ${{ secrets.VNET_SUBNET_PREFIX }} \
            --tags ${{ env.tags }}

      - name: VNET peer üîÄ
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            # Local VNET peer
            az network vnet peering create \
            --name vnet-peer-${{ env.product }}-001 \
            --vnet-name vnet-${{ env.product }}-001 \
            --remote-vnet $(az network vnet show --subscription ${{ secrets.REMOTE_VNET_SUBSCRIPTION }} --resource-group ${{ secrets.VNET_REMOTE_RESOURCE_GROUP }} --name ${{ secrets.REMOTE_VNET }} --query 'id' -o tsv) \
            --allow-vnet-access 1

            # Remote VNET peer
            az network vnet peering create \
            --name vnet-peer-${{ env.product }}-001 \
            --vnet-name  ${{ secrets.REMOTE_VNET }} \
            --remote-vnet $(az network vnet show --name vnet-${{ env.product }}-001 --query 'id' -o tsv) \
            --allow-vnet-access 1 \
            --subscription ${{ secrets.REMOTE_VNET_SUBSCRIPTION }} \
            --resource-group ${{ secrets.VNET_REMOTE_RESOURCE_GROUP }}

            # Fetch peering state
            echo "Peering state: $(az network vnet peering show \
            --vnet-name vnet-${{ env.product }}-001 \
            --name vnet-peer-${{ env.product }}-001 \
            --query peeringState)"

      - name: Container app environment üóÉÔ∏è
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az containerapp env create \
            --name cae-${{ env.product }}-${{ env.target }}-001 \
            --infrastructure-subnet-resource-id $(az network vnet subnet show --name snet-${{ env.product }}-001 --vnet-name vnet-${{ env.product }}-001 --query 'id' -o tsv) \
            --tags ${{ env.tags }}

      - name: Container app - MDM üìÑ
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az containerapp create \
            --name ca-${{ env.product }}-mdm-${{ env.target }}-001 \
            --environment cae-${{ env.product }}-${{ env.target }}-001 \
            --registry-server cr${{ env.product }}${{ env.target }}001.azurecr.io \
            --registry-username $(az acr credential show -n cr${{ env.product }}${{ env.target }}001 --query username | tr -d '"') \
            --cpu 1.0 \
            --memory 2.0Gi \
            --min-replicas 1 \
            --max-replicas 4 \
            --ingress external \
            --target-port ${{ vars.MDM_PORT }} \
            --revisions-mode multiple \
            --transport auto \
            --tags ${{ env.tags }}

      - name: Container app - TFS üìÑ
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az containerapp create \
            --name ca-${{ env.product }}-tfs-${{ env.target }}-001 \
            --environment cae-${{ env.product }}-${{ env.target }}-001 \
            --registry-server cr${{ env.product }}${{ env.target }}001.azurecr.io \
            --registry-username $(az acr credential show -n cr${{ env.product }}${{ env.target }}001 --query username | tr -d '"') \
            --cpu 1.0 \
            --memory 2.0Gi \
            --min-replicas 1 \
            --max-replicas 4 \
            --ingress external \
            --target-port ${{ vars.MDM_PORT }} \
            --revisions-mode multiple \
            --transport auto \
            --tags ${{ env.tags }}

      - name: Container app - ESTORE üìÑ
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az containerapp create \
            --name ca-${{ env.product }}-estore-${{ env.target }}-001 \
            --environment cae-${{ env.product }}-${{ env.target }}-001 \
            --registry-server cr${{ env.product }}${{ env.target }}001.azurecr.io \
            --registry-username $(az acr credential show -n cr${{ env.product }}${{ env.target }}001 --query username | tr -d '"') \
            --cpu 1.0 \
            --memory 2.0Gi \
            --min-replicas 1 \
            --max-replicas 4 \
            --ingress external \
            --target-port ${{ vars.MDM_PORT }} \
            --revisions-mode multiple \
            --transport auto \
            --tags ${{ env.tags }}              

      - name: API management ‚ö°Ô∏è
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az apim create \
            --name apim-${{ env.environment }}-${{ env.target }}-001 \
            --publisher-email ${{ secrets.NOTIFICATION }} \
            --publisher-name UKEF \
            --public-network-access true \
            --sku-capacity 1 \
            --sku-name ${{ vars.APIM_PLAN }} \
            --tags ${{ env.tags }}

  # 3. Container app configuration
  ca:
    name: Container app üîß
    needs: base
    environment: ${{ needs.base.outputs.environment }}
    runs-on: [ self-hosted, APIM, infrastructure]
    steps:
      - name: Pre-production üí´
        if: contains('["dev", "staging"]', env.target)
        run: echo "type=Preproduction" >> $GITHUB_ENV

      - name: Production üí´
        if: ${{ 'prod' == env.target }}
        run: echo "type=Production" >> $GITHUB_ENV

      - name: Tags üè∑Ô∏è
        run: echo tags='Environment=${{ env.type }}' \
          'Product=${{ env.product }}' \
          'Team=development' >> $GITHUB_ENV

      - name: Login üîê
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure defaults ‚ú®
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            # Basic
            az configure --defaults location=${{ vars.REGION }}
            az configure --defaults group=rg-${{ env.product }}-${{ env.target }}-001

      - name: IP restriction
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            # Add APIM public IP

            # MDM
            az containerapp ingress access-restriction set \
            --name ca-${{ env.product }}-mdm-${{ env.target }}-001 \
            --action Allow \
            --ip-address $(az apim show --name apim-infrastructure-dev-001 --query publicIpAddresses -o tsv) \
            --rule-name APIM \
            --description 'Allow APIM public IP address'
          
            # TFS
            az containerapp ingress access-restriction set \
            --name ca-${{ env.product }}-tfs-${{ env.target }}-001 \
            --action Allow \
            --ip-address $(az apim show --name apim-infrastructure-dev-001 --query publicIpAddresses -o tsv) \
            --rule-name APIM \
            --description 'Allow APIM public IP address'

            # ESTORE
            az containerapp ingress access-restriction set \
            --name ca-${{ env.product }}-estore-${{ env.target }}-001 \
            --action Allow \
            --ip-address $(az apim show --name apim-infrastructure-dev-001 --query publicIpAddresses -o tsv) \
            --rule-name APIM \
            --description 'Allow APIM public IP address'

  # 4. APIM configuration
  apim:
    name: API management üîß
    needs: base
    environment: ${{ needs.base.outputs.environment }}
    runs-on: [ self-hosted, APIM, infrastructure]
    steps:
      - name: Pre-production üí´
        if: contains('["dev", "staging"]', env.target)
        run: echo "type=Preproduction" >> $GITHUB_ENV

      - name: Production üí´
        if: ${{ 'prod' == env.target }}
        run: echo "type=Production" >> $GITHUB_ENV

      - name: Tags üè∑Ô∏è
        run: echo tags='Environment=${{ env.type }}' \
          'Product=${{ env.product }}' \
          'Team=development' >> $GITHUB_ENV

      - name: Login üîê
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure defaults ‚ú®
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            # Basic
            az configure --defaults location=${{ vars.REGION }}
            az configure --defaults group=rg-${{ env.product }}-${{ env.target }}-001
      
      - name: MDM - Product ‚ûï
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az apim product create \
            --service-name apim-${{ env.environment }}-${{ env.target }}-001 \
            --product-name apim-${{ env.product }}-mdm \
            --description 'Master database management endpoints' \
            --state published \
            --approval-required true \
            --subscription-required true
      
      - name: TFS - Product ‚ûï
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az apim product create \
            --service-name apim-${{ env.environment }}-${{ env.target }}-001 \
            --product-name apim-${{ env.product }}-tfs \
            --description 'Trade finance system endpoints' \
            --state published \
            --approval-required true \
            --subscription-required true

      - name: eStore - Product ‚ûï
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az apim product create \
            --service-name apim-${{ env.environment }}-${{ env.target }}-001 \
            --product-name apim-${{ env.product }}-estore \
            --description 'eStore document management system endpoints' \
            --state published \
            --approval-required true \
            --subscription-required true

      - name: MDM - API import ‚¨áÔ∏è
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az apim api import \
            --display-name 'MDM' \
            --description 'Master database management endpoints' \
            --service-url $(az containerapp show --name ca-${{ env.product }}-mdm-${{ env.target }}-001 --query properties.latestRevisionFqdn -o tsv)\
            --path '' \
            --service-name apim-${{ env.environment }}-${{ env.target }}-001 \
            --specification-format OpenApiJson \
            --api-type http \
            --api-version ${{ vars.API_VERSION }} \
            --protocols https \
            --subscription-required true

      - name: MDM - Product + API üß±
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az apim product api add \
            --service-name apim-${{ env.environment }}-${{ env.target }}-001 \
            --api-id $(az apim api list --service-name apim-${{ env.environment }}-${{ env.target }}-001 --filter-display-name 'mdm' --top 1 --query [0].name -o tsv) \
            --product-id $(az apim product list --service-name apim-${{ env.environment }}-${{ env.target }}-001 --query '[?contains(displayName, `apim-${{ env.product }}-mdm`)].name' -o tsv)

      - name: TFS - Product + API üß±
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az apim product api add \
            --service-name apim-${{ env.environment }}-${{ env.target }}-001 \
            --api-id $(az apim api list --service-name apim-${{ env.environment }}-${{ env.target }}-001 --filter-display-name 'tfs' --top 1 --query [0].name -o tsv) \
            --product-id $(az apim product list --service-name apim-${{ env.environment }}-${{ env.target }}-001 --query '[?contains(displayName, `apim-${{ env.product }}-tfs`)].name' -o tsv)
            
      - name: ESTORE - Product + API üß±
        uses: Azure/cli@1.0.4
        with:
          inlineScript: |
            az apim product api add \
            --service-name apim-${{ env.environment }}-${{ env.target }}-001 \
            --api-id $(az apim api list --service-name apim-${{ env.environment }}-${{ env.target }}-001 --filter-display-name 'estore' --top 1 --query [0].name -o tsv) \
            --product-id $(az apim product list --service-name apim-${{ env.environment }}-${{ env.target }}-001 --query '[?contains(displayName, `apim-${{ env.product }}-estore`)].name' -o tsv)
